# Процесс установки

## 1. Включение Hyper-V

```powershell
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform
Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform
```

## 2. Установка и конфигурация WSL

### Установка Windows Subsystem for Linux (WSL)

Настройте WSL версии 1 для использования подлючения Bridge вместо NAT (используется в версии 2). Команды выполняются с правами администратора.

```powershell
wsl --install -d ubuntu
wsl --set-version ubuntu 1
```

### Установка Ansible

```bash
sudo apt update
sudo apt install python3-pip -y
echo 'PATH=~/.local/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
pip install --user ansible==7.3.0
pip install pywinrm==0.4.3 --user
```

Создайте файл `/etc/wsl.conf` со следующим содержимым, чтобы Ansible мог подключаться к Linux-узлу по SSH:

```bash
# Enable extra metadata options by default
[automount]
enabled = true
root = /mnt/
options = "metadata,umask=77,fmask=11"
mountFsTab = false
```

Затем выполните команду `Restart-Service LxssManager` в PowerShell.

### Установка Vagrant

```bash
echo 'export VAGRANT_WSL_ENABLE_WINDOWS_ACCESS="1"' >> ~/.bashrc
echo 'export VAGRANT_DEFAULT_PROVIDER=hyperv' >> ~/.bashrc
source ~/.bashrc
wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install vagrant -y
```

> Для запуска и инициализации всех виртуальных машин требуется несколько плагинов vagrant.  Если команды установки плагинов vagrant не выполняются, откройте  PowerShell с правами администратора и выполните команду `Restart-Service LxssManager`.

```bash
vagrant plugin install winrm
vagrant plugin install winrm-fs
vagrant plugin install winrm-elevated
```

## 3. Настройка среды 

Hyper-V не предоставляет инструментов для создания внутренних сетей, в отличии от VirtualBox или VMWare. Поэтому необходимо создать виртуальный коммутатор и задать IP-адрес новому сетевому адаптеру.

Выполните следующие команды в PowerShell от с правами администратора:

```powershell
New-VMSwitch -SwitchName "NATSwitch" -SwitchType Internal

New-NetIPAddress -IPAddress 10.0.1.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NATSwitch)" 

New-NetNAT -Name "NATNetwork" -InternalIPInterfaceAddressPrefix 10.0.1.0/24
```

Затем необходимо настроить DHCP-сервер, чтобы узлы могли получать IP-адреса в той же сети. Это необходимо только для процесса установки, затем можно удалить DHCP-сервер. Можно использовать следующий DHCP-сервер: [www.dhcpserver.de](https://www.dhcpserver.de). Установите его в каталог `C:\widhcp` и не забудьте настроить исключения брандмауэра.

После завершения процесса выполнения `dhcpwiz.exe`, замените содержимое файла `dhcpsrv.ini` на файл из репозитория.

```bash
[SETTINGS]
IPPOOL_1=10.0.1.1-254
IPBIND_1=10.0.1.1
AssociateBindsToPools=1
Trace=1
DeleteOnRelease=0
ExpiredLeaseTimeout=3600

[GENERAL]
LEASETIME=86400
NODETYPE=8
SUBNETMASK=255.255.255.0
NEXTSERVER=10.0.1.1
DNS_0=1.1.1.1
ROUTER_0=10.0.1.1

[DNS-SETTINGS]
EnableDNS=0
FORWARD=1.1.1.1

[TFTP-SETTINGS]
EnableTFTP=0
ROOT=C:\widhcp\wwwroot
WritePermission=0

[HTTP-SETTINGS]
EnableHTTP=1
ROOT=C:\widhcp\wwwroot
```

Запустите DHCP-сервер, октрыв файл `dhcpsrv.exe` от имени администратора.

Загрузите репозиторий в `C:\`, чтобы к нему можно было легко получить доступ через Ubuntu WSL

Когда сервер будет запущен, откройте Ubuntu WSL от имени администратора, выполните следующую команду и дождитесь ее завершения. После этого можно остановить и удалить DHCP-сервер.

```bash
cd /mnt/c/capsulecorp-pentest/
vagrant up goku vegeta gohan trunks raditz tien kali --provision
```

Наконец, необходимо установить `EnhancedSessionTransportType` на каждом узле, чтобы воспользоваться возможностями буфера обмена Hyper-V. Для этого выполните следующие команды в PowerShell с правами администратора:

```powershell
Set-VM -VMName ccpt_kms,ccpt_kali -EnhancedSessionTransportType HvSocket
Set-VM -VMName ccpt_development,ccpt_goku,ccpt_krillin,ccpt_raditz,ccpt_gohan,ccpt_tien -EnhancedSessionTransportType VMBus
```

# Удаление

1. В Ubuntu WSL выполните с правами администратора следующие команды:

```bash
vagrant destroy goku vegeta gohan trunks raditz tien kali -f
rm -rf /mnt/c/capsulecorp-pentest/
 vagrant box list | cut -d ' ' -f 1 | xargs -I {} bash -c "vagrant box remove -f {}"
```

2. Выполните в PowerShell от имени администратора следующие команды:

```powershell
Remove-VMSwitch -SwitchName "NATSwitch" -Force
Remove-NetNat -Confirm:$false -Name "NATNetwork"
```

3. Отключите Hyper-V с поммощью PowerShell от имени администратора:

> Если необходимо включить Hyper-V, измените `off` на `auto`.

```powershell
# To Turn it off
bcdedit /set hypervisorlaunchtype off

# To uninstall it completely
Disable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
Disable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform
Disable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform
```